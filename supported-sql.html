<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Supported SQL | Okera User Documentation</title>
<link rel="stylesheet" href="theme/css/syntax.css">
<link rel="icon" type="image/png" href="/assets/images/icon-favicon32.png">

<script src="https://use.fontawesome.com/d9343c4626.js"></script>

<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="theme/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
  crossorigin="anonymous">
<!-- Old Algolia Instant Search -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css"> -->
<!-- End Old Algolia Instant Search -->
<link rel="stylesheet" href="theme/css/asciidoctor.css">
<link rel="stylesheet" href="theme/css/custom.css">
<link rel="stylesheet" href="theme/css/boxshadowproperties.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="theme/js/jquery.navgoco.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
  crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="theme/js/toc.js"></script>
<script src="theme/js/customscripts.js"></script>

<!-- Old Algolia Instant Search -->
<!-- <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script> -->
<!-- End Old Algolia Instant Search -->

<!-- Include AlgoliaSearch JS Client and autocomplete.js library -->
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>

<script>
  $(document).ready(function () {
    $("blockquote:contains('Note')").addClass("admonitionblock note");
    $("blockquote:contains('Warning')").addClass("admonitionblock warning");
    $("blockquote:contains('Tip')").addClass("admonitionblock tip");
    $(".admonitionblock.note").prepend('<i class="fa fa-check admonition"></i>');
    $(".admonitionblock.warning").prepend('<i class="fa fa-exclamation-triangle admonition"></i>');
    $(".admonitionblock.tip").prepend('<i class="fa fa-lightbulb-o admonition"></i>');
  });
</script>


<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">

        <div class="row">
            <div class="col-sm-4 col-md-3">

                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="navbar-wordmark">
                        <a href="/">
                            <img src="assets/images/okera-wordmark-white.svg" alt="Okera wordmark" />
                        </a>
                    </div>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

                    <ul class="nav navbar-nav">
                        <!-- toggle sidebar button -->
                        <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                        <!-- entries without drop-downs appear here -->

                            
                        <li>
                            <a href="https://okera.com" target="_blank">okera.com</a>
                        </li>
                          
                        <!-- entries with drop-downs appear here -->
                        <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                         
                    </ul>
                </div>
            </div>
            <form class="aa-input-container navbar-form" id="aa-input-container" role="search">
                <div class="form-group">
                    <input id="aa-search-input" type="text" class="aa-input-search form-control" placeholder="Search"
                        autocomplete="off">
                </div>
            </form>
        </div>
        <!-- Algolia Integrated search Script -->
        <script type="text/javascript" src="theme/js/okera-integrated-search.js"></script>
        <!-- comment out this block if you want to hide jekyll search
                  <div class="navbar-form" id="search-demo-container">
                      <form action="/search" method="GET">
                      <input type="text" name="q" id="search-input" placeholder="Search the docs...">
                      </form>
                  </div>
                end search -->
    </div>
</nav>
<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav affix">
  <li class="sidebarTitle"> </li>
  
  
  
  <li>
      <a href="#">Introduction to Okera</a>
      <ul>
          
          
          
          <li><a href="product-overview">Product Overview</a> </li>
          
          
          
          
          
          
          <li><a href="odas-overview">Okera Data Access Service Overview</a> </li>
          
          
          
          
          
          
          <li><a href="catalog-overview">Okera Catalog Overview</a> </li>
          
          
          
          
          
          
          <li><a href="okera-architecture-overview">Platform Architecture Overview</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Installing Okera</a>
      <ul>
          
          
          
          <li><a href="getting-started">Getting Started</a> </li>
          
          
          
          
          
          
          <li><a href="install">Installation Overview</a> </li>
          
          
          
          
          
          
          <li><a href="install-prereqs">Installation Prerequisites</a> </li>
          
          
          
          
          
          
          <li><a href="install-dm">Setting up the Deployment Manager</a> </li>
          
          
          
          
          
          
          <li><a href="install-odas">Setting up the ODAS Cluster</a> </li>
          
          
          
          
          
          
          <li><a href="advanced-install">Advanced Installation Options</a> </li>
          
          
          
          
          
          
          <li><a href="awsguide">AWS Guide</a> </li>
          
          
          
          
          
          
          <li><a href="odas-authentication">Authentication Guide</a> </li>
          
          
          
          
          
          
          <li><a href="kerberos-cluster-setup">Kerberos</a> </li>
          
          
          
          
          
          
          <li><a href="secure-okera-rest-api-ldap">LDAP Authentication</a> </li>
          
          
          
          
          
          
          <li><a href="secure-okera-rest-api-oauth">OAuth Authentication</a> </li>
          
          
          
          
          
          
          <li><a href="secure-deployment-manager-rest-api">Deployment Manager REST Security</a> </li>
          
          
          
          
          
          
          <li><a href="support-versions">Versions</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Administering ODAS Clusters</a>
      <ul>
          
          
          
          <li><a href="cluster-administration">Cluster Administration</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-types">Cluster Types</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-sizing">Cluster Sizing</a> </li>
          
          
          
          
          
          
          <li><a href="memory-usage">Platform Memory Usage</a> </li>
          
          
          
          
          
          
          <li><a href="ip-address-management">IP Address Management</a> </li>
          
          
          
          
          
          
          <li><a href="kubernetes-dashboard-quickstart">Cluster Monitoring with Kubernetes Addons</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-launch-plugin-api">Cluster Launch API</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Using the Catalog</a>
      <ul>
          
          
          
          <li><a href="authorization">Role-based Access Control</a> </li>
          
          
          
          
          
          
          <li><a href="privileges">Privileges</a> </li>
          
          
          
          
          
          
          <li><a href="schema-design">Schema Design</a> </li>
          
          
          
          
          
          
          <li><a href="authorization-builtins">Authorization Builtin Functions</a> </li>
          
          
          
          
          
          
          <li><a href="auditing">Auditing</a> </li>
          
          
          
          
          
          
          <li><a href="okera-database-cli">Database CLI</a> </li>
          
          
          
          
          
          
          <li class="active"><a href="supported-sql">Supported SQL</a></li>
          
          
          
          
          
          
          <li><a href="jdbc-data-source">JDBC Data Source</a> </li>
          
          
          
          
          
          
          <li><a href="data-types">Supported Data Types</a> </li>
          
          
          
          
          
          
          <li><a href="complex-types">Complex Data Types</a> </li>
          
          
          
          
          
          
          <li><a href="extending-odas">Extending ODAS</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Using the Web UI</a>
      <ul>
          
          
          
          <li><a href="web-ui-basics">Okera Portal Basics</a> </li>
          
          
          
          
          
          
          <li><a href="datasets-page">Datasets Page</a> </li>
          
          
          
          
          
          
          <li><a href="permissions-page">Permissions Page</a> </li>
          
          
          
          
          
          
          <li><a href="reports-page">Reports Page</a> </li>
          
          
          
          
          
          
          <li><a href="web-ui-admin">Okera Portal for Admins</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Integrating with ODAS</a>
      <ul>
          
          
          
          <li><a href="catalog-rest-api">REST API</a> </li>
          
          
          
          
          
          
          <li><a href="client-configs">Client Configuration</a> </li>
          
          
          
          
          
          
          <li><a href="hive-best-practices">Hive Integration - Best Practices</a> </li>
          
          
          
          
          
          
          <li><a href="emr-integration">EMR Integration</a> </li>
          
          
          
          
          
          
          <li><a href="pyokera">Native Python Integration</a> </li>
          
          
          
          
          
          
          <li><a href="client-integration">Client Integration</a> </li>
          
          
          
          
          
          
          <li><a href="planner-integration">Planner Integration</a> </li>
          
          
          
          
          
          
          <li><a href="third-party-integration">Third-Party Integration</a> </li>
          
          
          
          
          
          
          <li><a href="odas-cdh-integration">CDH Integration</a> </li>
          
          
          
          
          
          
          <li><a href="tableau-web-data-connector">Tableau Integration</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Reference</a>
      <ul>
          
          
          
          <li><a href="release-notes">Release Notes</a> </li>
          
          
          
          
          
          
          <li><a href="earlier-release-notes">Earlier Release Notes</a> </li>
          
          
          
          
          
          
          <li><a href="service-port-assignments">Service Ports</a> </li>
          
          
          
          
          
          
          <li><a href="s3-encryption-support">Supported S3 Encryption Types</a> </li>
          
          
          
          
          
          
          <li><a href="compatibility-guarantees">Compatibility Guarantees</a> </li>
          
          
          
          
          
          
          <li><a href="quick-recipes">Quick Recipes</a> </li>
          
          
          
          
          
          
          <li><a href="https://okera.zendesk.com/hc/en-us/categories/115000493607-FAQs" target="_blank">Frequently Asked Questions</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
        -->
    
    <li>
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2', title: 'On This Page' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 80);
  return false
})

});
</script>

<div id="toc"></div>

    </li>
    

</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            

<div class="post-content">

   

    


    

  <h1 id="supported-sql">Supported SQL</h1>

<p>ODAS enables the use of SQL for defining datasets.
This is done by creating base datasets and then defining views.
ODAS is not a full massively parallel processing (MPP) analytics engine, as only a subset of SQL is permitted.
This document describes the supported SQL subset.</p>

<p>ODAS in general supports the identical data model as Apache Hive and is generally compatible with HiveQL.
Supported functionality may differ depending on the client.</p>

<h2 id="data-definition-language-ddl-statements">Data Definition Language (DDL) Statements</h2>

<p>ODAS generally supports and is compatible with HiveQL DDL statements.
In some cases, ODAS is not compatible.
In other cases, the supported SQL has been extended for ODAS-specific capabilities – including all statements that modify the catalog and do not read any data (for example, <code class="highlighter-rouge">CREATE</code>, <code class="highlighter-rouge">DROP</code>, <code class="highlighter-rouge">ALTER</code>).</p>

<h3 id="msck-repair">MSCK REPAIR</h3>

<p>ODAS does not support the Hive <code class="highlighter-rouge">MSCK REPAIR TABLE &lt;table_name&gt;</code>.
Instead it supports the alternative, <code class="highlighter-rouge">ALTER TABLE &lt;table_name&gt; RECOVER PARTITIONS</code>.
This command otherwise behaves identically, automatically adding partitions to the table based on the storage directory structure.</p>

<h3 id="extensions">Extensions</h3>

<h4 id="optionally-drop-permissions">Optionally Drop Permissions</h4>

<p>There are use cases where it is valid to retain or drop permissions when the corresponding Catalog object (database, table, or view) is dropped.
ODAS extends the <code class="highlighter-rouge">DROP DATABASE</code>, <code class="highlighter-rouge">DROP TABLE</code>, and <code class="highlighter-rouge">DROP VIEW</code> statements to optionally specify whether the associated permissions should also be dropped.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="p">[</span><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="n">db</span> <span class="p">[</span><span class="k">CASCADE</span><span class="p">]</span> <span class="p">[(</span><span class="k">INCLUDING</span> <span class="o">|</span> <span class="k">EXCLUDING</span><span class="p">)</span> <span class="n">PERMISSIONS</span><span class="p">];</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">tbl</span> <span class="p">[(</span><span class="k">INCLUDING</span> <span class="o">|</span> <span class="k">EXCLUDING</span><span class="p">)</span> <span class="n">PERMISSIONS</span><span class="p">];</span>
<span class="k">DROP</span> <span class="k">VIEW</span> <span class="p">[</span><span class="n">IF</span> <span class="k">EXISTS</span><span class="p">]</span> <span class="p">[</span><span class="n">db</span><span class="p">.]</span><span class="n">v</span> <span class="p">[(</span><span class="k">INCLUDING</span> <span class="o">|</span> <span class="k">EXCLUDING</span><span class="p">)</span> <span class="n">PERMISSIONS</span><span class="p">];</span>
</code></pre></div></div>

<p>If <code class="highlighter-rouge">INCLUDING PERMISSIONS</code> is specified, the corresponding permissions are also dropped.
Otherwise, permissions will <em>not</em> be dropped, and they will be applied to future catalog objects with that name.
If <code class="highlighter-rouge">CASCADE</code> is specified, then all permissions on the tables and views in the database are dropped.</p>

<p>It is recommended that users default to the <code class="highlighter-rouge">INCLUDING PERMISSIONS</code> behavior and update existing workflows so as to not rely on permissions being retained longer than the object for which they are created.</p>

<p><strong>Example:</strong> DROP directives with <code class="highlighter-rouge">INCLUDING PERMISSIONS</code></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">database1</span> <span class="k">CASCADE</span> <span class="k">INCLUDING</span> <span class="n">PERMISSIONS</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">database2</span><span class="p">.</span><span class="n">table1</span> <span class="k">INCLUDING</span> <span class="n">PERMISSIONS</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">VIEW</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">database2</span><span class="p">.</span><span class="n">view1</span> <span class="k">INCLUDING</span> <span class="n">PERMISSIONS</span><span class="p">;</span>
</code></pre></div></div>

<p>For users to drop the permissions, they must have grant permissions on the catalog object.
For example, to be able to drop a database and its permissions, the user must be able to issue <code class="highlighter-rouge">GRANT</code>/<code class="highlighter-rouge">REVOKE</code> statements on the database.
The user needs to be a catalog admin or having been granted grant permissions.</p>

<h4 id="create-table-as-select">CREATE TABLE AS SELECT</h4>

<p>ODAS supports tables created by this method with the following restrictions:</p>

<ul>
  <li>
    <p>The table must be created from Hive in EMR.</p>
  </li>
  <li>
    <p>The Hive warehouse must have been configured to use S3 (as opposed to using the EMR-local HDFS cluster).</p>
  </li>
</ul>

<blockquote>
  <p><strong>Note:</strong> This functionality is not supported from odb.</p>
</blockquote>

<h4 id="create-table-over-a-single-file">Create table over a single file</h4>

<p>Hive tables (and partitions) traditionally were defined over a directory of files.
In ODAS, it is possible to define a table to a single file by specifying as the location, the full path to the file.
This allows creating tables without first having to create the parent directory and moving the data files.</p>

<p><strong>Example:</strong> <code class="highlighter-rouge">CREATE</code> for a table to a single file</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">TABLE</span> <span class="n">tbl</span><span class="p">(</span><span class="n">s</span> <span class="n">string</span><span class="p">)</span>
<span class="k">LOCATION</span> <span class="s1">'s3://bucket/path/file.parquet'</span>
</code></pre></div></div>

<p>In this example, when this table is scanned only the specified path is read, specifically, no other files in the ‘s3://bucket/path/’ directory.</p>

<p>Note that tables created this way may not read correctly if the client is bypassing ODAS.
For example, Hive clients that are directly reading this table without ODAS, may fail.</p>

<h4 id="registering-hive-serializationdeserialization-serde-libraries">Registering Hive Serialization/Deserialization (SerDe) Libraries</h4>

<p>See <a href="extending-odas">Extending ODAS</a> for the DDL grammar and other SerDe considerations.</p>

<h4 id="creating-user-defined-functions-udfs">Creating User Defined Functions (UDFs)</h4>

<p>See <a href="extending-odas">Extending ODAS</a> for the DDL grammar and other UDF considerations.</p>

<h4 id="internal-versus-external-views">Internal versus External Views</h4>

<p>Okera views can be defined as either internal or external.
This distinction defines how Okera evaluates data at runtime.
It could have a profound effect when evaluating joins between tables and views.</p>

<p>In both internal and external cases, data resides in its source systems.
Okera managed data continues to be managed in Okera.
External views continue to be managed by their non-Okera source.</p>

<p>The primary difference between internal and external views is that external data is not evaluated during a ODAS query.
External data does not have fine-grained access control, UDFs, and other features that Okera provides to managed datasets.</p>

<p>It is because of this property that joins are handled differently in internal views verses external views.</p>

<p>Okera manages the join of views defined in ODAS created from two tables or views, internal or external, at the query level.
Okera evaluates the join prior to it being sent to the analytics/compute engine for further processing.
This allows for fine-grained access control and UDF functionality to be applied to the entire view, regardless of where the source data resides.</p>

<blockquote>
  <p><strong>Note</strong></p>

  <p>ODAS is not a compute engine. Full SQL functionality is not available through the ODAS SQL interface.
The use of a compute engine for full analytics functionality is required.
For a list of known SQL incompatibilities, refer to the <a href="#known-incompatibilities">Known Incompatibilities</a> section in this document.</p>
</blockquote>

<p><strong>External views</strong> created of two tables or views, internal or external, are evaluated in a slightly different way.
Data managed by ODAS continues to be evaluated within the ODAS cluster.
But, the join between the two tables or views occurs in the analytics/compute engine.
The advantage of this approach is that ODAS continues to provide fine-grained access control and UDFs on ODAS managed data, while allowing the sometimes heavy compute of a join to be done outside the ODAS system.</p>

<p>External views require an analytics engine such as Hive or Spark to process aggregate requests and complete the join prior to execution.</p>

<h3 id="creating-external-views">Creating External Views</h3>

<p>This section provides a number of example common <code class="highlighter-rouge">EXTERNAL</code> view uses.</p>

<p><strong>Example:</strong> Creating an external view that requires no evaluation in ODAS</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">VIEW</span> <span class="n">random_user_subset</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">all_users</span> <span class="k">WHERE</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<blockquote>
  <p><strong>Note:</strong> Views on aggregate functions need to be created as <code class="highlighter-rouge">EXTERNAL</code> views, since the aggregates are calculated in compute applications like Hive or Spark.</p>
</blockquote>

<p><strong>Example:</strong> Creating external views with aggregate functions</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">EXTERNAL</span> <span class="k">VIEW</span> <span class="n">revenue_cal</span>
<span class="k">AS</span> <span class="k">SELECT</span> <span class="k">min</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">minRevenue</span><span class="p">,</span>
<span class="k">max</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">maxRevenue</span>
<span class="k">FROM</span> <span class="n">sales_transactions</span>
<span class="k">WHERE</span> <span class="n">region</span> <span class="o">=</span> <span class="s1">'california'</span>
</code></pre></div></div>

<p>Since compute applications do not accept the “<code class="highlighter-rouge">EXTERNAL</code> view” syntax, it can be executed using odb or Okera Web UI.</p>

<p>By default, views without <code class="highlighter-rouge">EXTERNAL</code> are evaluated in Okera, maintaining backwards compatibility with all previous ODAS functions.</p>

<h4 id="last-partitionslast-files">LAST PARTITIONS/LAST FILES</h4>

<p>ODAS extends the SQL grammar to easily restrict a table scan to just the most recent parts of a dataset.
This can be very useful for development or adhoc queries that only need to scan the most recent data, for example the last day or weeks worth.
It is expected that these clauses can be used during development, switching to the complete dataset once the application is developed.</p>

<p>OKERA supports the <code class="highlighter-rouge">LAST N PARTITIONS</code>, <code class="highlighter-rouge">LAST N FILES</code> and <code class="highlighter-rouge">LAST PARTITION</code>.
<code class="highlighter-rouge">LAST PARTITION</code> is just an alias for <code class="highlighter-rouge">LAST 1 PARTITIONS</code>.</p>

<p>For example, if the data is partitioned by day, <code class="highlighter-rouge">LAST PARTITION</code> can be used to always return the results for the last day.
<code class="highlighter-rouge">LAST 30 PARTITIONS</code> will return the last month and <code class="highlighter-rouge">LAST 100 FILES</code> will return the most recent 100 files worth of data.</p>

<p>These clauses can be added after the table name as an extension of the <code class="highlighter-rouge">FROM</code> clause.</p>

<p><strong>Example:</strong> Returning the last days results using <code class="highlighter-rouge">LAST N PARTITIONS</code></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">10</span> <span class="n">PARTITIONS</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">fact_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">20</span> <span class="n">FILES</span><span class="p">);</span>
</code></pre></div></div>

<p>For the last partition clauses, the partitions returned refer to the newest partitions of the table after sorting by partition.
Note that this may not be the partition from when data was most recently added.
It is <em>not</em> the last-modified partition.</p>

<p>As an example, if the table is partitioned by year, month, and day, it will always return the latest dates regardless of when the partitions were added or when the data in the partitions changed.</p>

<p>These <code class="highlighter-rouge">LAST</code> clause computation occurs after partition pruning is done.</p>

<p><strong>Example:</strong> Filtering the window for which to select the last partition</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">)</span> <span class="k">where</span> <span class="k">year</span> <span class="o">=</span> <span class="mi">2010</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">part_tbl</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">3</span> <span class="n">PARTITIONS</span><span class="p">)</span> <span class="k">where</span> <span class="k">month</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
</code></pre></div></div>
<p>These queries respectively return the last partition, the last partition in 2010, and the last 3 partitions in June.</p>

<p>Since the <code class="highlighter-rouge">LAST</code> clauses are specified per table, it is possible to specify it for each table in a query independently.</p>

<p>For example:</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t1</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">10</span> <span class="n">PARTITIONS</span><span class="p">)</span>
<span class="k">JOIN</span> <span class="n">t2</span> <span class="p">...</span>
<span class="k">JOIN</span> <span class="n">t3</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="last-clause-on-views">LAST clause on views</h5>

<p>If the <code class="highlighter-rouge">LAST</code> clause is specified on a view, then it is propagated to each base table (recursively) in the view.
It is invalid to specify the <code class="highlighter-rouge">LAST</code> clause on the view and on the <code class="highlighter-rouge">LAST</code> clause on an object in the view definition as this can be ambiguous.</p>

<p><strong>Example:</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v1</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">base_tbl</span><span class="p">;</span>

<span class="c1">-- This automatically propagates last to the base table and will only scan 1 partition.</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v1</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span>

<span class="c1">-- If the view is a UNION ALL, it will do so on each base table.</span>
<span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v2</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">base_tbl1</span> <span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">base_tbl2</span><span class="p">;</span>

<span class="c1">-- This will select 1 partition from each table</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v2</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span>

<span class="c1">-- Views can be created ontop of these with the last clause</span>
<span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v3</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v1</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">10</span> <span class="n">PARTITIONS</span><span class="p">);</span>

<span class="c1">-- This will select up to 10 partitions each.</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v3</span><span class="p">;</span>

<span class="c1">-- Both of these are invalid as it is not possible to have multiple LAST clauses</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v3</span><span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span> <span class="c1">-- INVALID: last from v3 clause and SELECT clause</span>
<span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v3</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">v1</span><span class="p">(</span><span class="k">LAST</span> <span class="mi">10</span> <span class="n">FILES</span><span class="p">);</span> <span class="c1">-- INVALID for same reason.</span>
</code></pre></div></div>

<h5 id="last-clause-as-catalog-metadata">LAST clause as catalog metadata</h5>

<p>In the previous example, the last clause would need to be explicitly specified, either as part of the query, or as explicit views that users use.
While the explicit view definition (e.g. <code class="highlighter-rouge">sales_data.transactions_dev_sample</code>, which is a view ontop of <code class="highlighter-rouge">sales_data.transactions</code>) has benefits, it may be easier to just set it as a property on the base tables or views.
This can be done by setting the <code class="highlighter-rouge">okera.default-last-n-partitions</code> property on the ODAS catalog object.
The value should be an integer, which specifies a default <code class="highlighter-rouge">LAST N PARTITIONS</code> clause.</p>

<p>For example,</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Returns all partitions</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">sales_data</span><span class="p">.</span><span class="n">transactions</span><span class="p">;</span>

<span class="c1">-- Set catalog metadata so that queries by default will only scan 3 partitions</span>
<span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sales_data</span><span class="p">.</span><span class="n">transactions</span> <span class="k">SET</span> <span class="n">TBLPROPERTIES</span><span class="p">(</span><span class="s1">'okera.default-last-n-partitions'</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

<span class="c1">-- Now the same query will automatically scan only the last 3 partitions.</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">sales_data</span><span class="p">.</span><span class="n">transactions</span><span class="p">;</span>
</code></pre></div></div>

<p>The default value in the metadata is only used if</p>
<ul>
  <li>No predicates are specified on the partition columns.
If a query explicitly specified a partitioning column, this value is ignored.</li>
  <li>No explicit <code class="highlighter-rouge">LAST</code> clause is specified.</li>
</ul>

<p>This property can be set on base tables and views.</p>

<p>The expected usage of this feature is to set this property on the largest datasets to implement automatic sampling.
This can dramatically improve BI or ad-hoc use cases and end users can get sampling transparently.
As this is intended to be transparent to the end user, it may be difficult for users to know this is happening and this should be reserved for tables where sampling is appropriate.</p>

<h5 id="limitations">Limitations</h5>

<ul>
  <li><code class="highlighter-rouge">LAST PARTITIONS</code> can only be used in internal views as other compute engines may not be able to support it.</li>
</ul>

<p><strong>Example:</strong> Improper query with no view</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">t</span><span class="p">)</span> <span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>Example:</strong> Recommended alternative with view creation</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">t_last_partition</span>
<span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t</span> <span class="p">(</span><span class="k">LAST</span> <span class="n">PARTITION</span><span class="p">);</span>

<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">t_last_partition</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Catalog metadata configuration only supports partitions, not files.</li>
</ul>

<h4 id="drop_table_or_view">DROP_TABLE_OR_VIEW</h4>

<p>ODAS supports <code class="highlighter-rouge">DROP_TABLE_OR_VIEW</code> which can be used instead of <code class="highlighter-rouge">DROP TABLE</code> or <code class="highlighter-rouge">DROP VIEW</code>.
This DDL statement will drop the dataset regardless of whether the dataset is a table or view.
Since this extends the SQL grammar, this is only available from tools that directly interact with ODAS, such as <code class="highlighter-rouge">odb</code> or the UI workspace.
This is not available from, for example, hive CLI.</p>

<h3 id="known-incompatibilities">Known Incompatibilities</h3>

<h4 id="stricter-type-promotion">Stricter Type Promotion**</h4>

<p>Hive/HiveQL is very permissive in type promotions, allowing implicit conversions between most types.
In ODAS, only lossless type promotion is implicit (for example, INT -&gt; BIGINT).
Explicit <code class="highlighter-rouge">cast()</code> functions may need to be added for existing SQL statements.</p>

<h4 id="disallowing-explicit-partitioning-clause-when-creating-views">Disallowing Explicit Partitioning Clause when Creating Views**</h4>

<p>Hive/HiveQL is used for creating views with an explicit partitioning clause.</p>

<p><strong>Example:</strong> Creating views with an explicit partitioning clause</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">v</span> <span class="k">as</span> <span class="k">SELECT</span> <span class="p">...</span> <span class="k">FROM</span> <span class="n">base_tbl</span>
<span class="n">PARTITIONED</span> <span class="k">BY</span> <span class="n">c1</span>
</code></pre></div></div>

<p>ODAS does not allow partitioning to be specified for views.
Partitioning is instead inferred based on the view statement and base table.
The partitioning on the base table is preserved for the view.</p>

<p>This is disallowed.
It is unclear what the semantics are, if the partitioning specified in the view is different from the base table, and what the resulting performance implications might be.</p>

<h2 id="data-manipulation-language-dml-statements">Data Manipulation Language (DML) Statements</h2>

<p>ODAS is not a distributed SQL engine.
It only supports a subset of SQL statements.
It does not support the other DML statements (such as <code class="highlighter-rouge">INSERT</code>, <code class="highlighter-rouge">DELETE</code>, <code class="highlighter-rouge">UPDATE</code>, etc).
And even for <code class="highlighter-rouge">SELECT</code> statements, only a subset of the SQL standard is supported.
A typical configuration is to run a SQL engine (on top of Spark or Presto) on top of ODAS.</p>

<p><code class="highlighter-rouge">SELECT</code> statements with projection, filters and union all are fully supported.</p>

<p><code class="highlighter-rouge">COUNT(*)</code> with no grouping is the only aggregation supported.
Multiple records are returned for this query, each containing a partial count.
Summing up all the counts returns the complete result.</p>

<h3 id="union-all">UNION ALL</h3>

<p>ODAS supports <code class="highlighter-rouge">UNION ALL</code> but not <code class="highlighter-rouge">UNION DISTINCT</code>.
Per the SQL standard, <code class="highlighter-rouge">UNION</code> without a qualifier defaults to <code class="highlighter-rouge">UNION DISTINCT</code> so <code class="highlighter-rouge">ALL</code> needs to be explicitly specified.</p>

<p>For example:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">okera_sample</span><span class="p">.</span><span class="n">sample</span> <span class="k">UNION</span> <span class="k">ALL</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">okera_sample</span><span class="p">.</span><span class="n">sample</span>
</code></pre></div></div>

<h3 id="joins">JOINs</h3>

<p>When using views, ODAS supports a limited set of joins for the purpose of restricting access to specific rows for particular users.
A canonical use case could be having a fact dataset for user transactions, which contains a column for the user ID.
Another, much-smaller dataset, contains the set of user ids that allow analytics to be carried out on their activity.
ODAS would support filtering the transactions dataset by creating a view that is a join over the two.</p>

<p>The specific limitations are:</p>

<ul>
  <li>Only <code class="highlighter-rouge">INNER</code> and <code class="highlighter-rouge">LEFT</code> (optionally with <code class="highlighter-rouge">OUTER</code>, <code class="highlighter-rouge">SEMI</code>, <code class="highlighter-rouge">ANTI</code>) joins are allowed.</li>
  <li>The smaller tables must be under a maximum configured size.
If the smaller tables exceed the maximum configured size, the request fails at runtime.</li>
</ul>

<p>Subquery rewrites are supported but must be executable subject to the same constraints.</p>

<h4 id="configurations">Configurations</h4>

<p>Configurations can be specified at cluster creation time by using the CLI.</p>

<p>By default, joins are enabled with a maximum memory of 128MB per join.</p>

<p><strong>Example:</strong> Disabling joins entirely during cluster creation</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ocadm clusters create <span class="nt">--plannerConfigs</span> <span class="s2">"enable_joins=false"</span> ...
</code></pre></div></div>

<p><strong>Example:</strong> Setting the maximum memory during cluster creation to 256MB</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ocadm clusters create <span class="nt">--workerConfigs</span> <span class="s2">"join_max_mem=256000000"</span> ...
</code></pre></div></div>

<p>See the <a href="cluster-sizing">Cluster Sizing</a> document for more information on how much memory joins need and how that affects cluster node requirements.</p>


    <div class="tags">
        
    </div>




</div>



<footer>
  <div class="row">
    <div class="col-lg-12 footer">
      <div class="footer-meta">
        &copy;2019 Okera, Inc. All rights reserved.  Site last generated: Mar 28, 2019
      </div>
    </div>
  </div>
</footer>

        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
