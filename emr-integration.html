<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" ">
<title>Okera Data Access Service EMR Integration | Okera User Documentation</title>
<link rel="stylesheet" href="theme/css/syntax.css">
<link rel="icon" type="image/png" href="/assets/images/icon-favicon32.png">

<script src="https://use.fontawesome.com/d9343c4626.js"></script>

<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="theme/css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
  crossorigin="anonymous">
<!-- Old Algolia Instant Search -->
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css"> -->
<!-- End Old Algolia Instant Search -->
<link rel="stylesheet" href="theme/css/asciidoctor.css">
<link rel="stylesheet" href="theme/css/custom.css">
<link rel="stylesheet" href="theme/css/boxshadowproperties.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="theme/js/jquery.navgoco.min.js"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
  crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="theme/js/toc.js"></script>
<script src="theme/js/customscripts.js"></script>

<!-- Old Algolia Instant Search -->
<!-- <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script> -->
<!-- End Old Algolia Instant Search -->

<!-- Include AlgoliaSearch JS Client and autocomplete.js library -->
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>

<script>
  $(document).ready(function () {
    $("blockquote:contains('Note')").addClass("admonitionblock note");
    $("blockquote:contains('Warning')").addClass("admonitionblock warning");
    $("blockquote:contains('Tip')").addClass("admonitionblock tip");
    $(".admonitionblock.note").prepend('<i class="fa fa-check admonition"></i>');
    $(".admonitionblock.warning").prepend('<i class="fa fa-exclamation-triangle admonition"></i>');
    $(".admonitionblock.tip").prepend('<i class="fa fa-lightbulb-o admonition"></i>');
  });
</script>


<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">

        <div class="row">
            <div class="col-sm-4 col-md-3">

                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="navbar-wordmark">
                        <a href="/">
                            <img src="assets/images/okera-wordmark-white.svg" alt="Okera wordmark" />
                        </a>
                    </div>
                </div>

                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

                    <ul class="nav navbar-nav">
                        <!-- toggle sidebar button -->
                        <!-- <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li> -->
                        <!-- entries without drop-downs appear here -->

                            
                        <li>
                            <a href="https://okera.com" target="_blank">okera.com</a>
                        </li>
                          
                        <!-- entries with drop-downs appear here -->
                        <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                         
                    </ul>
                </div>
            </div>
            <form class="aa-input-container navbar-form" id="aa-input-container" role="search">
                <div class="form-group">
                    <input id="aa-search-input" type="text" class="aa-input-search form-control" placeholder="Search"
                        autocomplete="off">
                </div>
            </form>
        </div>
        <!-- Algolia Integrated search Script -->
        <script type="text/javascript" src="theme/js/okera-integrated-search.js"></script>
        <!-- comment out this block if you want to hide jekyll search
                  <div class="navbar-form" id="search-demo-container">
                      <form action="/search" method="GET">
                      <input type="text" name="q" id="search-input" placeholder="Search the docs...">
                      </form>
                  </div>
                end search -->
    </div>
</nav>
<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                


<ul id="mysidebar" class="nav affix">
  <li class="sidebarTitle"> </li>
  
  
  
  <li>
      <a href="#">Introduction to Okera</a>
      <ul>
          
          
          
          <li><a href="product-overview">Product Overview</a> </li>
          
          
          
          
          
          
          <li><a href="odas-overview">Okera Data Access Service Overview</a> </li>
          
          
          
          
          
          
          <li><a href="catalog-overview">Okera Catalog Overview</a> </li>
          
          
          
          
          
          
          <li><a href="okera-architecture-overview">Platform Architecture Overview</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Installing Okera</a>
      <ul>
          
          
          
          <li><a href="getting-started">Getting Started</a> </li>
          
          
          
          
          
          
          <li><a href="install">Installation Overview</a> </li>
          
          
          
          
          
          
          <li><a href="install-prereqs">Installation Prerequisites</a> </li>
          
          
          
          
          
          
          <li><a href="install-dm">Setting up the Deployment Manager</a> </li>
          
          
          
          
          
          
          <li><a href="install-odas">Setting up the ODAS Cluster</a> </li>
          
          
          
          
          
          
          <li><a href="advanced-install">Advanced Installation Options</a> </li>
          
          
          
          
          
          
          <li><a href="awsguide">AWS Guide</a> </li>
          
          
          
          
          
          
          <li><a href="odas-authentication">Authentication Guide</a> </li>
          
          
          
          
          
          
          <li><a href="kerberos-cluster-setup">Kerberos</a> </li>
          
          
          
          
          
          
          <li><a href="secure-okera-rest-api-ldap">LDAP Authentication</a> </li>
          
          
          
          
          
          
          <li><a href="secure-okera-rest-api-oauth">OAuth Authentication</a> </li>
          
          
          
          
          
          
          <li><a href="secure-deployment-manager-rest-api">Deployment Manager REST Security</a> </li>
          
          
          
          
          
          
          <li><a href="support-versions">Versions</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Administering ODAS Clusters</a>
      <ul>
          
          
          
          <li><a href="cluster-administration">Cluster Administration</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-types">Cluster Types</a> </li>
          
          
          
          
          
          
          <li><a href="standalone-jdbc-cluster">Standalone JDBC Cluster</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-sizing">Cluster Sizing</a> </li>
          
          
          
          
          
          
          <li><a href="memory-usage">Platform Memory Usage</a> </li>
          
          
          
          
          
          
          <li><a href="ip-address-management">IP Address Management</a> </li>
          
          
          
          
          
          
          <li><a href="kubernetes-dashboard-quickstart">Cluster Monitoring with Kubernetes Addons</a> </li>
          
          
          
          
          
          
          <li><a href="cluster-launch-plugin-api">Cluster Launch API</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Integrating with ODAS</a>
      <ul>
          
          
          
          <li><a href="third-party-integration">Integration Overview</a> </li>
          
          
          
          
          
          
          <li><a href="planner-integration">Planner Integration</a> </li>
          
          
          
          
          
          
          <li><a href="pyokera">Native Python Integration</a> </li>
          
          
          
          
          
          
          <li><a href="catalog-rest-api">REST API Integration</a> </li>
          
          
          
          
          
          
          <li class="active"><a href="emr-integration">AWS EMR Integration</a></li>
          
          
          
          
          
          
          <li><a href="odas-cdh-integration">Cloudera CDH Integration</a> </li>
          
          
          
          
          
          
          <li><a href="databricks-integration">Databricks Integration</a> </li>
          
          
          
          
          
          
          <li><a href="client-integration">Hadoop Client Integration</a> </li>
          
          
          
          
          
          
          <li><a href="client-configs">Hive and Spark Client Integration</a> </li>
          
          
          
          
          
          
          <li><a href="hive-best-practices">Hive Integration - Best Practices</a> </li>
          
          
          
          
          
          
          <li><a href="aws-cloudtrail-integration">AWS CloudTrail Integration Quick Start</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Using the Catalog</a>
      <ul>
          
          
          
          <li><a href="authorization-abac">Attribute-based Access Control</a> </li>
          
          
          
          
          
          
          <li><a href="authorization">Role-based Access Control</a> </li>
          
          
          
          
          
          
          <li><a href="privileges">Privileges</a> </li>
          
          
          
          
          
          
          <li><a href="schema-design">Schema Design</a> </li>
          
          
          
          
          
          
          <li><a href="authorization-builtins">Authorization Builtin Functions</a> </li>
          
          
          
          
          
          
          <li><a href="auditing">Auditing</a> </li>
          
          
          
          
          
          
          <li><a href="okera-database-cli">Database CLI</a> </li>
          
          
          
          
          
          
          <li><a href="supported-sql">Supported SQL</a> </li>
          
          
          
          
          
          
          <li><a href="jdbc-data-source">JDBC Data Source</a> </li>
          
          
          
          
          
          
          <li><a href="data-types">Supported Data Types</a> </li>
          
          
          
          
          
          
          <li><a href="complex-types">Complex Data Types</a> </li>
          
          
          
          
          
          
          <li><a href="extending-odas">Extending ODAS</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Using the Web UI</a>
      <ul>
          
          
          
          <li><a href="web-ui-basics">Okera Portal Basics</a> </li>
          
          
          
          
          
          
          <li><a href="datasets-page">Datasets Page</a> </li>
          
          
          
          
          
          
          <li><a href="permissions-page">Permissions Page</a> </li>
          
          
          
          
          
          
          <li><a href="workspace-page">Workspace</a> </li>
          
          
          
          
          
          
          <li><a href="reports-page">Reports Page</a> </li>
          
          
          
          
          
          
          <li><a href="data-registration">Data Registration</a> </li>
          
          
          
          
          
          
          <li><a href="managing-tags">Managing Tags</a> </li>
          
          
          
          
          
          
          <li><a href="autotagging-configuration">Configuring Auto-Tagger</a> </li>
          
          
          
          
          
          
          <li><a href="web-ui-admin">Okera Portal for Admins</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Reference</a>
      <ul>
          
          
          
          <li><a href="release-notes">Release Notes</a> </li>
          
          
          
          
          
          
          <li><a href="earlier-release-notes">Earlier Release Notes</a> </li>
          
          
          
          
          
          
          <li><a href="service-port-assignments">Service Ports</a> </li>
          
          
          
          
          
          
          <li><a href="s3-encryption-support">Supported S3 Encryption Types</a> </li>
          
          
          
          
          
          
          <li><a href="compatibility-guarantees">Compatibility Guarantees</a> </li>
          
          
          
          
          
          
          <li><a href="quick-recipes">Quick Recipes</a> </li>
          
          
          
          
          
          
          <li><a href="https://okera.zendesk.com/hc/en-us/categories/115000493607-FAQs" target="_blank">Frequently Asked Questions</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Tutorials</a>
      <ul>
          
          
          
          <li><a href="onboarding-datasets">Onboarding datasets</a> </li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
        -->
    
    <li>
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2', title: 'On This Page' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 80);
  return false
})

});
</script>

<div id="toc"></div>

    </li>
    

</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            

<div class="post-content">

   

    


    

  <h1 id="okera-data-access-service-emr-integration">Okera Data Access Service EMR Integration</h1>

<p>This documents describes how to use Okera Data Access Service (ODAS) from EMR and how to configure each of the supported EMR services.
It assumes that the ODAS cluster is already running.</p>

<p>As part of the EMR set up, we will specify the following:</p>

<ul>
  <li>
    <p>A bootstrap action to download the Okera client libraries on the EMR cluster nodes</p>
  </li>
  <li>
    <p>A bootstrap script to set the appropriate user account permissions on the EMR cluster</p>
  </li>
  <li>
    <p>A configuration to set the client libraries to use the existing ODAS installation</p>
  </li>
</ul>

<p>This is optional for some components, but required for Hive, Spark, and Presto.
An EMR cluster that is using multiple components should apply each configuration.</p>

<blockquote>
  <p><strong>Note:</strong> EMR versions 5.1.0 through 5.20.0 are supported by the latest bootstrap scripts.
<strong>Note:</strong> Presto support is enabled only starting in EMR 5.3.0</p>
</blockquote>

<h2 id="bootstrap-scripts">Bootstrap Scripts</h2>

<p>The following subsections discuss the mentioned bootstrap scripts provided for ODAS.
These scripts can be run on an existing EMR cluster, or specified as part of the bootstrap actions when creating an EMR cluster using the AWS web-based UI.
The subsections show the interactive usage of the scripts, while the <a href="#end-to-end-operational-example">end-to-end example</a> is showing their use in the AWS UI.</p>

<h3 id="emr-node-bootstrap">EMR Node Bootstrap</h3>

<p>The first bootstrap action places the client jars in the <code class="highlighter-rouge">/usr/lib/okera</code> directory and creates links into component-specific library paths.
To configure an EMR cluster, run the script, and specify the version and components you have installed. The script downloads the component
libraries from the useast region. To use uswest region, an optional step, specify the env variable OKERA_BITS_REGION to uswest
(export OKERA_BITS_REGION=uswest) in the initScript specified with –init option below.</p>

<p>The bootstrap script is located at:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s3://okera-release-useast/utils/emr/odas-emr-bootstrap.sh
</code></pre></div></div>

<h4 id="script-usage">Script Usage</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>odas-emr-bootstrap.sh &lt;odas_version&gt; <span class="o">[</span>options] &lt;list_of_components&gt;
</code></pre></div></div>

<p><strong>Options</strong></p>

<ul>
  <li><code class="highlighter-rouge">--planner-hostports &lt;hostports&gt;</code> – Link to the <code class="highlighter-rouge">cerebro_planner:planner</code> endpoint</li>
  <li><code class="highlighter-rouge">--init &lt;initScript&gt;</code> – s3 path init script to be run as part of bootstrap
This is useful to set env variables like HTTP_PROXY, OKERA_BITS_REGION.</li>
</ul>

<p>Notes:</p>
<ul>
  <li>See <a href="ip-address-management">IP Address Management</a> for details on how to retrieve the Planner endpoint</li>
  <li>See <a href="client-integration#required">Client Integration</a> for information on the <code class="highlighter-rouge">&lt;hostports&gt;</code> parameter</li>
</ul>

<p>For example, to bootstrap a Spark 2 cluster from the Okera 1.4.0 release, provide the arguments <code class="highlighter-rouge">1.4.0 spark-2.x</code> (the <code class="highlighter-rouge">--planner-hostports</code> and other parameters are omitted for the sake of brevity).
If running EMR with Spark 2 and Hive, provide <code class="highlighter-rouge">1.4.0 spark-2.x hive</code>.</p>

<p>The complete list of supported components are:</p>
<ul>
  <li>Apache Spark 2 (<code class="highlighter-rouge">spark-2.x</code>)</li>
  <li>Apache Hive (<code class="highlighter-rouge">hive</code>)</li>
  <li>Presto (<code class="highlighter-rouge">presto</code>)</li>
</ul>

<p>Non-compute components can also be used and do not require any ODAS-related steps.
These include:</p>
<ul>
  <li>Ganglia</li>
  <li>Apache ZooKeeper</li>
  <li>Apache Hue</li>
</ul>

<p>Non-compute components that require some ODAS-related setup</p>
<ul>
  <li>Apache Zeppelin (requires some setup to support user impersonation with ODAS)
    <ul>
      <li><a href="zeppelin">Configuration instructions</a></li>
    </ul>
  </li>
</ul>

<h3 id="user-setup-bootstrap">User Setup Bootstrap</h3>

<p>For the second bootstrap action, the following script is used to configure one or more users:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s3://okera-release-useast/utils/emr/bootstrap-users.sh
</code></pre></div></div>

<p>Run this script for at least one user (likely the default EMR user, <code class="highlighter-rouge">hadoop</code>).</p>

<h4 id="script-usage-1">Script Usage</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bootstrap-users.sh &lt;list_of_users&gt;
</code></pre></div></div>

<p>The <code class="highlighter-rouge">&lt;list_of_users&gt;</code> is delimited by spaces.</p>

<p><strong>Example:</strong> Setting up an EMR cluster for users <code class="highlighter-rouge">alice</code> and <code class="highlighter-rouge">bob</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bootstrap-users.sh alice bob
</code></pre></div></div>

<p>This script</p>

<ul>
  <li>creates the group <code class="highlighter-rouge">okera</code>;</li>
  <li>creates a background script in <code class="highlighter-rouge">/tmp/</code> for each service account (that is, <code class="highlighter-rouge">hive</code>, <code class="highlighter-rouge">presto</code>, <code class="highlighter-rouge">spark</code>, and <code class="highlighter-rouge">yarn</code>), waiting for the given account to exist;</li>
  <li>adds the account to the <code class="highlighter-rouge">okera</code> group;</li>
  <li>sets the expected permissions on both the given user’s home directory and the <code class="highlighter-rouge">.okera</code> directory within their home directory.</li>
</ul>

<p>The preceding steps result in the EMR service users having permission to read (and possibly write) a user’s token, because of their membership in the <code class="highlighter-rouge">okera</code> group.
Group membership enables the Okera client libraries to authenticate the user by passing the user’s token to the ODAS cluster with each call.</p>

<h2 id="end-to-end-operational-example">End-to-End Operational Example</h2>

<p>As an end-to-end operational example, we will start up a multi-tenant EMR cluster running Spark 2.x, Hive, and Presto, configured to run against an existing ODAS Planner running at <code class="highlighter-rouge">odas-planner-1.internal.net:12050</code>.</p>

<p>Notes:</p>
<ul>
  <li><em>Multi-tenant</em> here means that each EMR user is assigned their own authentication token.
This is the default and the recommended way of configuring the cluster.</li>
  <li>See <a href="ip-address-management">IP Address Management</a> for details on how to retrieve the actual Planner endpoint, and why using a DNS registered name is recommended.</li>
</ul>

<p><strong>Prerequisites</strong></p>

<p>Follow these initial steps to start with the cluster setup:</p>

<ul>
  <li>Start at the AWS UI with the EMR service selected.</li>
  <li>Click on the blue “Create cluster” button and wait for the next page to open.</li>
  <li>Select “Go to advanced options” at the top of the “Create Cluster” screen:</li>
</ul>

<p><img src="assets/images/screen-emr-create-cluster.png" alt="Create cluster page" /></p>

<p>You are now ready to perform the UI-based cluster creation process, explained next.</p>

<p><strong>Step 1: Choose your components.</strong></p>

<p>Pick <strong>Spark</strong>, <strong>Hive</strong>, and <strong>Presto</strong> from the list of EMR components.</p>

<p><img src="assets/images/screen-emr-step-1.png" alt="EMR Step 1" /></p>

<p>Set the Spark and Hive specific configuration options, by copy and pasting the following JSON:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="s2">"spark-defaults"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"spark.recordservice.planner.hostports"</span><span class="p">:</span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="s2">"spark-hive-site"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:{</span><span class="w">
      </span><span class="s2">"recordservice.planner.hostports"</span><span class="p">:</span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hive-site"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"hive.fetch.task.conversion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"minimal"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"hive.metastore.rawstore.impl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.cerebro.hive.metastore.CerebroObjectStore"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"hive.exec.pre.hooks"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.okera.recordservice.hive.SetTokenPreExecute"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"recordservice.planner.hostports"</span><span class="p">:</span><span class="w"> </span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Notes:</p>
<ul>
  <li>If you follow this example with a different ODAS Planner endpoint, please adjust the address and port to match your setup.</li>
  <li>Additional configuration examples are found in the program-specific sections below.</li>
  <li>Optionally, pick, for example, Hue and Zeppelin as components that do not require ODAS related configuration options.</li>
  <li>The <code class="highlighter-rouge">hive.exec.pre.hooks</code> is available and required for versions starting with <code class="highlighter-rouge">1.0.1</code>.
For versions prior, simply omit the config.</li>
</ul>

<p><strong>Step 2: Use your preferred EMR hardware setup.</strong></p>

<p>Ensure that you assign the proper VPC and EC2 Subnet to the cluster, which includes the requirement of the ODAS and EMR cluster being able to communicate with each other.
All the other options, regarding the instance types and EBS volume size, are based on your needs and can be selected as you see fit.</p>

<p><img src="assets/images/screen-emr-step-2.png" alt="EMR Step 2" /></p>

<p>Notes:</p>
<ul>
  <li>You typically only need the “Master” and “Core” node types, as the “Task” nodes are optional.</li>
</ul>

<p><strong>Step 3: Set your cluster name and bootstrap scripts.</strong></p>

<p>First, name your cluster something other than the default.</p>

<p>Second, configure the EMR cluster to use the Okera bootstrap scripts.
Do the following for the ODAS libraries script:</p>
<ul>
  <li>Add a “Custom action” under bootstrap actions.</li>
  <li>Set the script/JAR path to <code class="highlighter-rouge">s3://okera-release-useast/utils/emr/odas-emr-bootstrap.sh</code>.</li>
  <li>In the “Optional arguments” box enter (all in one line):
    <ul>
      <li>The ODAS version number this EMR is configured with.</li>
      <li>The <code class="highlighter-rouge">--planner-hostports</code> option with the proper ODAS Planner endpoint.</li>
      <li>The list of supported components to the bootstrap script.
Since we’re starting with Hive, Presto and Spark, specify <code class="highlighter-rouge">hive</code>, <code class="highlighter-rouge">presto</code>, and <code class="highlighter-rouge">spark-2.x</code>.</li>
    </ul>
  </li>
</ul>

<p>For example, copy and paste this (and adjust as needed) into the “Optional arguments” box:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.4.0 --planner-hostports odas-planner-1.internal.net:12050 hive presto spark-2.x
</code></pre></div></div>

<p>Notes:</p>
<ul>
  <li>All options should be specified before the list of components.</li>
</ul>

<p>For the user bootstrap script:</p>
<ul>
  <li>Add another “Custom action” under bootstrap actions.</li>
  <li>Set the script/JAR path to <code class="highlighter-rouge">s3://okera-release-useast/utils/emr/bootstrap-users.sh</code>.</li>
  <li>In the “Optional arguments” box enter the space-separated list of users to the script options (all in one line).
For example: <code class="highlighter-rouge">hadoop alice bob</code>.</li>
</ul>

<p><img src="assets/images/screen-emr-step-3.png" alt="EMR Step 3" /></p>

<p><strong>Step 4: Set up the security options.</strong></p>

<p>Select an EC2 key pair to use for the EMR cluster.
This is needed later on to configure the cluster nodes with per-user tokens.</p>

<p>Also, specify additional security groups in order for the EMR cluster to communicate with the ODAS cluster.
Add whatever security groups you specified for the ODAS hosts to the <strong>Master</strong>, <strong>Core</strong>, and, optionally,  <strong>Task</strong> rows.</p>

<p><img src="assets/images/screen-emr-step-4.png" alt="EMR Step 4" /></p>

<p><strong>Step 5: Create the EMR cluster and wait for it to be ready.</strong></p>

<p>The Okera components have been installed and configured when the cluster reports a ready status.</p>

<p><img src="assets/images/screen-emr-running.png" alt="EMR Running" /></p>

<p>Since this is a multi-tenant cluster, care must be taken to manage users that have access to this cluster.
Each user can authenticate to Okera with their own token, using access control, handled by Okera.
When the user is authenticated, Okera uses the username specified in the token.</p>

<blockquote>
  <p><strong>Note:</strong> The EMR username does not need to be the same as the subject in the user access token.</p>
</blockquote>

<p>The token can be installed with the following commands:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"&lt;longstringtoken&gt;"</span> <span class="o">&gt;</span> ~/.okera/token
</code></pre></div></div>

<p>The <code class="highlighter-rouge">&lt;longstringtoken&gt;</code> placeholder must be replaced with the user’s string token.
These commands need to be executed on every instance in the EMR cluster.
The <code class="highlighter-rouge">.okera</code> directory is created by the <code class="highlighter-rouge">bootstrap-users.sh</code>.
It is highly recommended to use that script to create this directory as it ensures that permissions are set correctly.</p>

<p><strong>Step 6: Querying data.</strong>
The user can now use the following EMR components to access data managed by Okera:</p>

<p><strong>Example:</strong> Accessing data with Presto’s CLI</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>presto-cli <span class="nt">--server</span> localhost:8889 <span class="nt">--catalog</span> hive <span class="nt">--schema</span> default
presto:default&gt; show catalogs<span class="p">;</span>
    Catalog
<span class="nt">---------------</span>
 hive
 recordservice
 system
<span class="o">(</span>3 rows<span class="o">)</span>

Query 20180421_102629_00002_fhhrx, FINISHED, 1 node
Splits: 1 total, 1 <span class="k">done</span> <span class="o">(</span>100.00%<span class="o">)</span>
0:00 <span class="o">[</span>0 rows, 0B] <span class="o">[</span>0 rows/s, 0B/s]

presto&gt; show tables <span class="k">in </span>recordservice.okera_sample<span class="p">;</span>
 Table
<span class="nt">--------</span>
 sample
 users
<span class="o">(</span>2 rows<span class="o">)</span>

Query 20180421_102722_00003_fhhrx, FINISHED, 2 nodes
Splits: 18 total, 18 <span class="k">done</span> <span class="o">(</span>100.00%<span class="o">)</span>
0:00 <span class="o">[</span>2 rows, 59B] <span class="o">[</span>6 rows/s, 185B/s]

presto&gt; <span class="k">select</span> <span class="k">*</span> from recordservice.okera_sample.sample<span class="p">;</span>
             record
<span class="nt">---------------------------------</span>
 This is a sample <span class="nb">test </span>file.
 It should consist of two lines.
<span class="o">(</span>2 rows<span class="o">)</span>

Query 20180421_102742_00004_fhhrx, FINISHED, 1 node
Splits: 17 total, 17 <span class="k">done</span> <span class="o">(</span>100.00%<span class="o">)</span>
0:00 <span class="o">[</span>2 rows, 0B] <span class="o">[</span>5 rows/s, 0B/s]
</code></pre></div></div>

<p><strong>Example:</strong> Accessing data with Hive</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hive
hive&gt; show databases<span class="p">;</span>
OK
default
okera_sample
demo
Time taken: 0.768 seconds, Fetched: 4 row<span class="o">(</span>s<span class="o">)</span>

hive&gt; <span class="k">select</span> <span class="k">*</span> from okera_sample.sample<span class="p">;</span>
OK
This is a sample <span class="nb">test </span>file.
It should consist of two lines.
Time taken: 2.292 seconds, Fetched: 2 row<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<p><strong>Example:</strong> Accessing data with Beeline</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>beeline <span class="nt">-u</span> jdbc:hive2://localhost:10000/default <span class="nt">-n</span> hadoop
beeline&gt; show tables <span class="k">in </span>okera_sample<span class="p">;</span>
+-----------+
| tab_name  |
+-----------+
| sample    |
| users     |
+-----------+
2 rows selected <span class="o">(</span>1.652 seconds<span class="o">)</span>

beeline&gt; <span class="k">select</span> <span class="k">*</span> from okera_sample.users limit 100<span class="p">;</span>
+---------------------------------------+------------+---------------+----------------------+
|               users.uid               | users.dob  | users.gender  |      users.ccn       |
+---------------------------------------+------------+---------------+----------------------+
| 0001BDD9-EABF-4D0D-81BD-D9EABFCD0D7D  | 8-Apr-84   | F             | 3771-2680-8616-9487  |
| 00071AA7-86D2-4EB9-871A-A786D27EB9BA  | 7-Feb-88   | F             | 4539-9934-1924-5730  |
...
| 009C0C19-A239-4137-9C0C-19A2396137B5  | 12-Nov-76  | F             | 5231-8965-0777-9503  |
| 009D9636-58C3-46EA-8743-B6D5BC7D3057  | 21-Feb-72  | M             | 3409-4704-3840-6971  |
+---------------------------------------+------------+---------------+----------------------+
100 rows selected <span class="o">(</span>2.854 seconds<span class="o">)</span>
</code></pre></div></div>

<p><strong>Example:</strong> Accessing data with Spark shell (Scala)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>spark-shell
scala&gt; val df <span class="o">=</span> spark.sql<span class="o">(</span><span class="s2">"select * from okera_sample.sample"</span><span class="o">)</span>
df: org.apache.spark.sql.DataFrame <span class="o">=</span> <span class="o">[</span>record: string]

scala&gt; df.show<span class="o">()</span>
+--------------------+
|              record|
+--------------------+
|This is a sample ...|
|It should consist...|
+--------------------+
</code></pre></div></div>

<h2 id="access-token-management">Access Token Management</h2>

<p>Okera supports multi-tenant EMR clusters, as each Okera connection includes the caller’s token.
Requests by users on the same EMR cluster using different tokens are independently authorized by Okera’s access controls.
They potentially see different data.</p>

<p>It is the responsibility of the EMR cluster to make sure that it is not easy for users on the same cluster to access other users’ tokens or data.
The token is never logged in its entirety by Okera, but the user needs to make sure that the token is not accidentally exposed through the OS.
For a secure multi-tenant cluster, Okera recommends users do not log in as the same user (for example, <code class="highlighter-rouge">hadoop</code>) and that the users logging in do not have root permissions.
Otherwise, the local cluster OS is not secure.
Similarly, not logging in as the same user, prevents users from viewing each other’s intermediate files in HDFS.</p>

<blockquote>
  <p><strong>Note:</strong> The EMR user does not have to match the token’s subject.
Okera authenticates the user using the token only.</p>
</blockquote>

<h3 id="adding-users-to-a-running-cluster">Adding users to a running cluster</h3>

<p>To add a user to a running EMR cluster that has already been ODAS bootstrapped, you can run <code class="highlighter-rouge">/usr/lib/okera/add-users.sh</code>.
Identical to <code class="highlighter-rouge">bootstrap-users.sh</code>, this takes a space-separated list of users. This script assumes that <code class="highlighter-rouge">boostrap-users.sh</code> has been run already and will only add additional users.
This script will create the user and the <code class="highlighter-rouge">.okera</code> home directory with the proper permissions.</p>

<p>In a common pattern, we expect system users such as <code class="highlighter-rouge">hadoop</code> to be bootstrapped at cluster creation time and additional users be added after.</p>

<h2 id="per-component-configuration">Per-Component Configuration</h2>

<p>The configurations required to configure each supported EMR component are detailed in this section.</p>

<p>You need to enter the JSON-based settings, listed below, while creating the EMR cluster, as shown in the <a href="#end-to-end-operational-example">end-to-end example</a>.
Otherwise you will need to modify the appropriate configuration files manually and restart the service(s); this applies to all EMR cluster nodes.</p>

<p>With all components, Okera requires specifying the ODAS Planner <em>hostport</em> (for example, <code class="highlighter-rouge">odas-planner-1.internal.net:12050</code>, which is used throughout this document).
You also need to have configured the access token as explained in <a href="#access-token-management">Access Token Management</a>.</p>

<blockquote>
  <p><strong>Warning:</strong> Previous versions of ODAS included a <em>single-tenant</em> approach, which configured a shared, per-service token in the configuration files of each service.
This approach is no longer recommended anymore (due to its complexity) and should not be used anymore.
Instead for single tenant clusters, simply bootstrap the hadoop user and place the token in this users home directory.</p>
</blockquote>

<h3 id="spark">Spark</h3>

<h4 id="setting-up-spark">Setting up Spark</h4>

<p>Use the following JSON configuration properties to set up Spark with an existing ODAS Planner:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="s2">"spark-defaults"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
       </span><span class="s2">"spark.recordservice.planner.hostports"</span><span class="p">:</span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
     </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="s2">"spark-hive-site"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:{</span><span class="w">
      </span><span class="s2">"recordservice.planner.hostports"</span><span class="p">:</span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>If you have an existing EMR cluster or prefer to manually edit the configuration files for Spark, you will have to change the following two files by adding the above settings:</p>

<p>File <code class="highlighter-rouge">/etc/spark/conf/spark-defaults.conf</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /etc/spark/conf/spark-defaults.conf
...
spark.recordservice.planner.hostports odas-planner-1.internal.net:12050
</code></pre></div></div>

<p>File <code class="highlighter-rouge">/etc/spark/conf/hive-site.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /etc/spark/conf/hive-site.xml
...
  <span class="nt">&lt;property&gt;</span>
    <span class="nt">&lt;name&gt;</span>recordservice.planner.hostports<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;value&gt;</span>odas-planner-1.internal.net:12050<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<h4 id="using-spark">Using Spark</h4>

<p>Once the cluster is set up, you can interact with the Spark shell as follows:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scala&gt; val df <span class="o">=</span> spark.sqlContext.read.format<span class="o">(</span><span class="s2">"com.cerebro.recordservice.spark"</span><span class="o">)</span>.load<span class="o">(</span><span class="s2">"&lt;DB.TABLE&gt;"</span><span class="o">)</span>
scala&gt; df.show<span class="o">()</span>
</code></pre></div></div>

<p>See the <a href="#end-to-end-operational-example">end-to-end example</a> for more.</p>

<h3 id="hive">Hive</h3>

<h4 id="setting-up-hive">Setting up Hive</h4>

<p>In addition to Planner endpoint, Hive requires two to settings to integrate with the Okera catalog:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"Classification"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hive-site"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"hive.fetch.task.conversion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"minimal"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"hive.metastore.rawstore.impl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"com.cerebro.hive.metastore.CerebroObjectStore"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"recordservice.planner.hostports"</span><span class="p">:</span><span class="w"> </span><span class="s2">"odas-planner-1.internal.net:12050"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>If you have an existing EMR cluster or prefer to manually edit the configuration files for Hive, you will have to change the following file by adding the above settings:</p>

<p>File <code class="highlighter-rouge">/etc/hive/conf/hive-site.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /etc/hive/conf/hive-site.xml
...
  <span class="nt">&lt;property&gt;</span>
    <span class="nt">&lt;name&gt;</span>hive.fetch.task.conversion<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;value&gt;</span>minimal<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property&gt;</span>
    <span class="nt">&lt;name&gt;</span>recordservice.planner.hostports<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;value&gt;</span>odas-planner-1.internal.net:12050<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
  <span class="nt">&lt;property&gt;</span>
    <span class="nt">&lt;name&gt;</span>hive.metastore.rawstore.impl<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;value&gt;</span>com.cerebro.hive.metastore.CerebroObjectStore<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;/property&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>
<h4 id="using-hive">Using Hive</h4>

<p>Hive is operated through either the <code class="highlighter-rouge">hive</code> or <code class="highlighter-rouge">beeline</code> command as shown below.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>hive
hive&gt; show databases<span class="p">;</span>
hive&gt; <span class="k">select</span> <span class="k">*</span> from okera_sample.sample<span class="p">;</span>
</code></pre></div></div>

<p>For Beeline, users must specify their local Unix user (for example, <code class="highlighter-rouge">hadoop</code>) at connection time:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>beeline <span class="nt">-u</span> jdbc:hive2://localhost:10000/default <span class="nt">-n</span> hadoop
beeline&gt; show tables <span class="k">in </span>okera_sample<span class="p">;</span>
beeline&gt; <span class="k">select</span> <span class="k">*</span> from okera_sample.users limit 100<span class="p">;</span>
</code></pre></div></div>

<p>See the <a href="#end-to-end-operational-example">end-to-end example</a> for more.</p>

<h4 id="cluster-local-databases">Cluster-local Databases</h4>

<p>With the default install, the Hive Metastore (HMS) running on the cluster populates all of its contents from the Okera Catalog.
In some cases, it could be useful to use HMS to register cluster-local (that is, temporary) tables, for example, for intermediate query results.</p>

<p>This can be done by configuring the set of databases that should only exist locally, either during bootstrap or by updating <code class="highlighter-rouge">hive-site.xml</code> and restarting the EMR HMS.
For example, the setup could be configured so that any Hive operation to the database <code class="highlighter-rouge">localdb</code> is cluster-local; this includes tables, views, and so forth.
This database is never reflected in Okera and access to data or metadata in these databases do not use Okera.</p>

<p>If Spark is included in the EMR cluster, the <code class="highlighter-rouge">global_temp</code> database is automatically setup to be cluster-local.</p>

<p>Local DBs are also useful in creating materialized views (caches of datasets from queries) for faster access.
An example would be to create a table in <code class="highlighter-rouge">localdb</code> using data from Okera datasets (using the <code class="highlighter-rouge">CREATE TABLE AS SELECT</code> statement).</p>

<p><strong>Example:</strong> Creating a table in <code class="highlighter-rouge">localdb</code></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">localdb</span><span class="p">.</span><span class="n">european_users</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">users</span> <span class="k">WHERE</span> <span class="n">region</span> <span class="o">=</span> <span class="s1">'europe'</span>
</code></pre></div></div>

<p>The location for these tables can be changed to an S3 bucket.
This can be set in <code class="highlighter-rouge">hive-site.xml</code>.</p>

<p><strong>Example:</strong> Changing table locations to an S3 bucket</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>hive.metastore.warehouse.dir<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>s3://okera/warehouse<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;description&gt;</span>location of default database for the warehouse<span class="nt">&lt;/description&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div></div>

<p>External storage location is supported for S3 buckets only.</p>

<p>In the case where the local database has the same name as an Okera database, the local database takes precedence, and the user is not able see the contents in that Okera database from Hive.</p>

<p><strong>Example:</strong> Configuring local databases in <code class="highlighter-rouge">hive-site.xml</code></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;property&gt;</span>
  <span class="nt">&lt;name&gt;</span>cerebro.local.dbs<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;value&gt;</span>localdb,testdb<span class="nt">&lt;/value&gt;</span>
  <span class="nt">&lt;description&gt;</span>
    Comma-separate list of local database names. These don't need to already exist.
  <span class="nt">&lt;/description&gt;</span>
<span class="nt">&lt;/property&gt;</span>
</code></pre></div></div>

<p><strong>Example:</strong> Configuring local databases using bootstrap script</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"Classification"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hive-site"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"cerebro.local.dbs"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localdb,testdb"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<blockquote>
  <p><strong>Note on local DBs</strong></p>

  <p>Any local database, and the datasets in it, are not accessible by ODAS.
The local database is ephemeral and is lost when the EMR cluster is shutdown.
If the storage is externalized to S3, or shared HDFS, then a new external table definition, with location set to the S3 folder, could be used to access the dataset.</p>
</blockquote>

<h4 id="known-incompatibilities">Known Incompatibilities</h4>

<p>In the context of a ODAS installation, Hive uses externalized metadata managed by ODAS.
As a result, it is not possible to alter the location of a table or partition to an Okera dataset by way of Hive.
Instead, altering the location is done through a native Okera client like the odb client.</p>

<p>Hive treats external tables, created using Hive against ODAS, as external, non-native types.
<code class="highlighter-rouge">ALTER TABLE</code> is not supported on external, non-native tables.</p>

<p><strong>Example:</strong> Using <code class="highlighter-rouge">odb</code> to alter the table location</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">odb</span> <span class="n">dataset</span> <span class="n">hive</span><span class="o">-</span><span class="n">ddl</span> <span class="nv">"alter table okera.users set location 's3a://okera/correctedlocation'"</span>
</code></pre></div></div>

<p>ODAS only supports using the cluster-local storage on a given EMR cluster.
Distributed file systems like EFS are not supported.
Using them, especially if mounted on multiple EMR clusters, can cause authentication issues preventing the use of ODAS.</p>

<h4 id="limitations">Limitations</h4>

<blockquote>
  <p><strong>Note:</strong> The ODAS authorization is not currently supported from the Hive CLI.
For example, <code class="highlighter-rouge">SHOW ROLES</code> does not list the ODAS roles.</p>
</blockquote>

<p>SQL data manipulation (DML), such as <code class="highlighter-rouge">INSERT</code> statements, is not supported in Hive.</p>

<h3 id="presto">Presto</h3>

<h4 id="setting-up-presto">Setting up Presto</h4>

<p>Presto requires configurations to be passed as arguments to the ODAS provided bootstrap script instead of providing them as configurations, but otherwise requires similar configs as the other components.</p>

<blockquote>
  <p><strong>Note:</strong> The options must come <em>before</em> the list of components.</p>
</blockquote>

<p><strong>Example:</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>odas-emr-bootstrap.sh 1.4.0 <span class="nt">--planner-hostports</span> odas-planner-1.internal.net:12050 presto
</code></pre></div></div>

<p>See the <a href="#emr-node-bootstrap">EMR Node Bootstrap</a> section for more details.</p>

<h4 id="using-presto">Using Presto</h4>

<p>Once the EMR cluster is launched, and the token has been stored (if necessary) you can interact with the <code class="highlighter-rouge">presto-cli</code> as you typically would.</p>

<p><strong>Example:</strong> Displaying catalogs using <code class="highlighter-rouge">presto-cli</code></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>presto-cli
presto&gt; show catalogs<span class="p">;</span>
</code></pre></div></div>
<p>This should return <code class="highlighter-rouge">recordservice</code> among others.</p>

<p><strong>Example:</strong> Querying metadata and select from tables</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>presto&gt; show tables <span class="k">in </span>recordservice.okera_sample<span class="p">;</span>
presto&gt; <span class="k">select</span> <span class="k">*</span> from recordservice.okera_sample.sample<span class="p">;</span>
</code></pre></div></div>

<h4 id="known-limitations">Known Limitations</h4>

<p>DDL and DML commands (besides <code class="highlighter-rouge">select</code>) are not supported in Presto.</p>

<h2 id="logging">Logging</h2>

<p>On the EMR instances, the bootstrapping logs are located in <code class="highlighter-rouge">/var/log/bootstrap-actions/</code>.
This is helpful if the cluster is not starting up and could indicate a misconfiguration of the bootstrap action.</p>

<h3 id="presto-1">Presto</h3>

<p>EMR precludes us from fully configuring logging for Presto.
To complete the configuration, edit the file located at <code class="highlighter-rouge">/etc/presto/conf.dist/jvm.config</code>, and add this line to its end (applies to all cluster nodes):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-Dlog4j</span>.configuration<span class="o">=</span>file:/etc/presto/conf/log4j.properties
</code></pre></div></div>

<p>In order for the Okera Presto plugin to log correctly, restart the Presto services on all of the nodes in the cluster.</p>

<h2 id="configs">Configs</h2>

<p>Configs are generally written to <code class="highlighter-rouge">/etc/[component]</code>.
Configs should replicate the configurations that were specified during cluster creation.</p>

<h2 id="updating-odas-client-libraries">Updating ODAS Client Libraries</h2>

<p>The ODAS client libraries are located in the <code class="highlighter-rouge">/usr/lib/okera</code> directory on each of the EMR instances.
To upgrade the ODAS client, become root user, download the client library, and restart the corresponding services.
Replace <code class="highlighter-rouge">&lt;odas_version&gt;</code> with the version of the ODAS client to which you are upgrading.
To restart the services, refer to
<a href="https://aws.amazon.com/premiumsupport/knowledge-center/restart-service-emr/">Amazon’s service restart instructions</a>.</p>

<h3 id="updating-client-libraries-presto">Updating Client Libraries: Presto</h3>

<ol>
  <li>
    <p>SSH to <strong>each</strong> EC2 node in the EMR cluster and perform the following:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/lib/okera
curl <span class="nt">-O</span> https://s3.amazonaws.com/okera-release-useast/&lt;odas_version&gt;/client/recordservice-presto.jar
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restart the Presto server on <strong>all</strong> the EC2 nodes:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stop presto-server
start presto-server
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="updating-client-libraries-hive">Updating Client Libraries: Hive</h3>

<ol>
  <li>
    <p>SSH to <strong>each</strong> of the EC2 nodes in the EMR cluster and do the following:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/lib/okera
curl <span class="nt">-O</span> https://s3.amazonaws.com/okera-release-useast/&lt;odas_version&gt;/client/recordservice-hive.jar
</code></pre></div>    </div>
  </li>
  <li>
    <p>On the <em>master</em> EC2 node, download the Hive metastore jar and restart both the Hive server and the Hive metastore:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/lib/okera
curl <span class="nt">-O</span> https://s3.amazonaws.com/okera-release-useast/&lt;odas_version&gt;/client/okera-hive-metastore.jar
stop hive-hcatalog-server
stop hive-server2
start hive-hcatalog-server
start hive-server2
</code></pre></div>    </div>
  </li>
</ol>


    <div class="tags">
        
    </div>




</div>



<footer>
  <div class="row">
    <div class="col-lg-12 footer">
      <div class="footer-meta">
        &copy;2019 Okera, Inc. All rights reserved.  Site last generated: Jun 4, 2019
      </div>
    </div>
  </div>
</footer>

        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
